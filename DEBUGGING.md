# Debugging Guide

Practical guide for investigating and debugging the nitro-fig trading bot in production.

## Replay TUI (Visual Debugging)

The fastest way to debug strategy behavior is the interactive replay TUI. It replays recorded data through the same strategy and risk code used in live trading, with full visualization.

```bash
# Record market data (5 cycles)
cargo run --release --bin recorder -- --cycles 5

# Replay a specific market
cargo run --release --bin replay -- logs/5m/btc-updown-5m-1771320600
```

**What to look for:**
- **Signal markers on BTC chart**: DarkGray triangles (up signals) and white triangles (down signals) show when strategies fire. Cyan/red dots show dispatched orders.
- **Fair value dots on PM charts**: Each strategy's fair value estimate appears as a colored dot. The gap between the dot and the bid/ask lines IS the edge the strategy detected. A large gap means the strategy sees significant mispricing.
- **Metrics panel**: Watch sigma, z-score, regime, and distance change tick by tick. Useful for understanding why a strategy gate opens or closes.
- **Signal/order tables**: Scrollable logs show every signal and order with edge, fair value, market price, and strategy name.

**Navigation**: Use `Left`/`Right` to step event by event, `Space` to play/pause, `PgDn`/`PgUp` to jump 100 events, `Home`/`End` for start/end. Press `s` to export all intermediate values to CSV for offline analysis.

See [README.md#replay-tui](README.md#replay-tui) for full keybinding reference.

---

## Backtest Binary

The `backtest` binary replays recorded market data through the full strategy + risk pipeline, using the same shared `process_signals()` function as the live engine. This ensures backtest results accurately reflect live trading behavior including signal deconfliction, sorting, house-side coherence, and slippage simulation.

Two modes: **Interactive TUI** (default) or **text dump** (`--dump`).

```bash
# Interactive TUI with 8-tab analytics dashboard
cargo run --release --bin backtest -- logs/1h

# Text dump to stdout (no TUI)
cargo run --release --bin backtest -- --dump logs/1h
```

**TUI Tabs (8):**

| Tab | What to look for |
|-----|-----------------|
| 1 Summary | Overall PnL, Sharpe/Sortino/Calmar ratios, directional bias, edge capture per strategy |
| 2 Strategies | Per-strategy comparison — scroll through to see equity curves, consecutive streaks, edge std |
| 3 Markets | Select a market with `j/k`, press `Enter` to drill-down into that market's individual trades |
| 4 Trades | Press `f` to cycle filter by strategy — isolate which strategy generates best/worst trades |
| 5 Equity | Per-trade equity with strategy overlays — look for divergence (one strategy dragging portfolio down) |
| 6 Risk | Drawdown chart — visualize how deep and long drawdowns last. PnL histogram shows tail risk |
| 7 Timing | PnL by time-remaining bucket — identifies if strategy performs better early or late in market |
| 8 Correl | Strategy correlation matrix — low correlation = good diversification. Watch for >0.7 pairs |

**Key differences from live engine:**
- Fills are assumed immediate at `market_ask + 1 cent slippage`
- No async channels — orders are pushed directly to `Vec<Fill>`
- BinanceState persists across markets (same as live)
- Uses `ProcessConfig::backtest()` (1 cent slippage) vs `ProcessConfig::live()` (0 slippage)

**Warning thresholds:**
- **Win rate < 60%**: Strategy calibration may need adjustment
- **Max drawdown > bankroll * 5%**: Risk limits may be too loose
- **Profit factor < 2.0**: Edge quality is marginal
- **Sortino < 0.5**: Downside volatility too high relative to returns
- **Strategy correlation > 0.7**: Two strategies are redundant — consider disabling one
- **Single market dominates losses**: Check if house-side was set by low-confidence signal (should be fixed by >= 0.7 gate)

---

## Reading Logs

### SSH and Tail

```bash
ssh root@82.24.195.32
tail -f /root/nitro-fig/logs/latest.log
```

### Filtering by Signal Type

The bot uses five log prefixes. Filter with grep to isolate what you need:

```bash
# Signals generated by strategies
tail -f /root/nitro-fig/logs/latest.log | grep SIG

# Fill confirmations (orders that executed)
tail -f /root/nitro-fig/logs/latest.log | grep FILL

# Diagnostic snapshots (every 10s — strategy gate analysis)
tail -f /root/nitro-fig/logs/latest.log | grep DIAG

# Engine lifecycle (market start, settlement, per-strategy breakdown)
tail -f /root/nitro-fig/logs/latest.log | grep ENGINE

# Warnings (stale data, halts)
tail -f /root/nitro-fig/logs/latest.log | grep WARN
```

### Monitoring Commands

```bash
# Watch signals and fills together
tail -f /root/nitro-fig/logs/latest.log | grep -E 'SIG|FILL|ENGINE.*ended'

# Monitor regime shifts in real time
tail -f /root/nitro-fig/logs/latest.log | grep DIAG | awk -F'regime=' '{print $2}' | cut -d' ' -f1

# Check for stale feed warnings
grep WARN /root/nitro-fig/logs/latest.log

# Watch Telegram delivery errors
grep TG /root/nitro-fig/logs/latest.log
```

---

## Understanding DIAG Output

Every 10 seconds the engine logs a `[DIAG]` block. Here is a real example with every field explained:

```
[DIAG] t_left=134s σ=0.00006569 z=-0.13 dist=$-7 dist_frac=0.00010 regime=Range(52%/196) house=Some(Up) up_ask=0.990 down_ask=0.990 S=69068.99 K=69076
[DIAG]   certainty_capture: z_abs=0.13 fair=0.553 ask=0.990 edge=-0.437 → z<1.5
[DIAG]   convexity_fade: regime=Range dist_frac=0.00010 → PASS(regime+dist)
[DIAG]   lp_extreme: z_abs=0.13 losing_side=Up ask=0.990 regime=Range → z<1.5
[DIAG]   strike_misalign: elapsed=168428ms → past_15s
```

### Header Line

| Field | Value in Example | Meaning |
|-------|-----------------|---------|
| `t_left` | `134s` | Seconds until market close (tau before oracle adjustment) |
| `σ` | `0.00006569` | Realized volatility per second from the 1-second sampled EWMA. Floored at ~0.0000534 (30% annualized) |
| `z` | `-0.13` | z-score: `ln(S/K) / (σ * sqrt(τ))`. How many standard deviations the price is from the strike. Negative means S < K (price below strike) |
| `dist` | `$-7` | Raw dollar distance: S - K. Negative means BTC is $7 below the strike |
| `dist_frac` | `0.00010` | Absolute fractional distance: `|S - K| / K`. Here 0.01% of the strike price |
| `regime` | `Range(52%/196)` | Tick direction regime. `Range` means dominant_frac < 60%. The `52%` is the fraction of direction-changing ticks going the same way, out of `196` total ticks in the 30s window |
| `house` | `Some(Up)` | Current side coherence direction. First active order set the house to Up. All subsequent active orders must agree. `None` means no orders dispatched yet |
| `up_ask` | `0.990` | Best Polymarket ask price for Up tokens. `0.990` typically means stale or no real liquidity (near max price) |
| `down_ask` | `0.990` | Best Polymarket ask price for Down tokens. Both at 0.990 means the PM order book is empty or stale |
| `S` | `69068.99` | Oracle-adjusted spot price estimate: `binance_price + beta` (beta defaults to 0) |
| `K` | `69076` | Strike price, set from the first Binance price when the market opened |

### Per-Strategy Gate Analysis

Each strategy line shows why it is blocked (or `PASS` if it would fire):

**certainty_capture**:
- `z_abs=0.13` — absolute z-score (needs >= 1.5)
- `fair=0.553` — model's fair probability for the near-certain side
- `ask=0.990` — market ask price for that side
- `edge=-0.437` — fair minus ask (needs >= 0.02)
- Gate result: `z<1.5` — blocked because z-score is too low (price too close to strike)

**convexity_fade**:
- `regime=Range` — must not be Trend (Range and Ambiguous are acceptable)
- `dist_frac=0.00010` — must be <= 0.003 (within 0.3% of strike)
- Gate result: `PASS(regime+dist)` — both gates pass. The strategy will fire if edge >= 0.02 on the next PM quote

**lp_extreme**:
- `z_abs=0.13` — needs >= 1.5
- `losing_side=Up` — if z < 0, the losing side is Up (would buy Up tokens as LP)
- `ask=0.990` — losing side's ask price (needs < 0.25 for cheap tail tokens)
- `regime=Range` — must not be Trend
- Gate result: `z<1.5` — blocked because the outcome is not lopsided enough

**strike_misalign**:
- `elapsed=168428ms` — milliseconds since market start
- Gate result: `past_15s` — blocked because this strategy only fires in the first 15 seconds

### Summary of Gate Conditions

| Strategy | Gate 1 | Gate 2 | Gate 3 | Gate 4 |
|----------|--------|--------|--------|--------|
| certainty_capture | `z_abs >= 1.5` | valid ask (0 < ask < 1) | `edge >= 0.02` | — |
| convexity_fade | `regime != Trend` | `dist_frac <= 0.003` | `edge >= 0.02` | `tau >= 30` |
| lp_extreme | `z_abs >= 1.5` | `losing_ask < 0.25` | `regime != Trend` | `tau >= 60` |
| strike_misalign | `elapsed <= 15000ms` | VWAP available | `|dP| >= 0.02` | — |

---

## Understanding Why an Order Fires

When a strategy clears all gates and passes risk checks, you see a SIG followed by a FILL:

```
[SIG] convexity_fade Up edge=0.187 fair=0.447 mkt=0.260 sz=$5.0 ACTIVE
[FILL] #1 [convexity_fade] Up Filled price=Some(0.26) size=Some(5.0) lat=0.0ms
```

### SIG Line

| Field | Meaning |
|-------|---------|
| `convexity_fade` | Strategy name that generated the signal |
| `Up` | Side: buying Up tokens (betting BTC finishes above strike) |
| `edge=0.187` | Fair value minus market price. The model thinks there is 18.7 cents of mispricing |
| `fair=0.447` | Model's fair probability of Up winning, computed via `Phi(d2)` |
| `mkt=0.260` | Current Polymarket ask price for Up tokens |
| `sz=$5.0` | Dollar size after half-Kelly sizing and risk caps |
| `ACTIVE` | Active signal: participates in side coherence. `PASSIVE` means lp_extreme (exempt from house view) |

### FILL Line

| Field | Meaning |
|-------|---------|
| `#1` | Order ID (sequential within the market) |
| `[convexity_fade]` | Strategy that originated this order |
| `Up` | Side that was filled |
| `Filled` | Status: `Filled`, `PartialFill`, or `Rejected` |
| `price=Some(0.26)` | Execution price on Polymarket CLOB |
| `size=Some(5.0)` | Dollar amount filled |
| `lat=0.0ms` | Submit-to-ack latency (0.0ms in dry-run mode) |

### What Happened

The convexity_fade strategy detected that Polymarket was offering Up tokens at $0.26 while the model's fair value was $0.447. That is 18.7 cents of edge in a range-bound regime with BTC near the strike. Half-Kelly sizing produced a $5.0 order. Risk checks passed (within per-trade cap, cooldown expired, portfolio room available). The order was sent and filled at $0.26.

---

## Understanding Settlement

At market end, the engine logs a settlement block:

```
[ENGINE] Market btc-updown-5m-1771294500 ended | outcome=Down | house=Some(Up) | sig=4213 ord=4 fill=4 pnl=$-11.10 (4fills settled)
[ENGINE]   latency_arb: sig=441 ord=2 fill=2 pnl=$-8.80 avg_edge=0.130
[ENGINE]   convexity_fade: sig=3772 ord=2 fill=2 pnl=$-2.30 avg_edge=0.128
```

### Header Line

| Field | Meaning |
|-------|---------|
| `outcome=Down` | Final settlement: BTC finished below the strike (S < K at market end) |
| `house=Some(Up)` | The bot's house view was Up (set by the first active order). The house was wrong this time |
| `sig=4213` | Total signals generated across all strategies during this market |
| `ord=4` | Orders that passed risk checks and were dispatched |
| `fill=4` | Orders that were confirmed filled on Polymarket |
| `pnl=$-11.10` | Gross PnL for this market. Negative because the house bet Up but outcome was Down |

### How PnL is Computed

Settlement is binary:
- **Correct side** (fill.side == outcome): `pnl = (1 - price) * size`. You paid `price`, received $1.00.
- **Wrong side** (fill.side != outcome): `pnl = -(price * size)`. You paid `price`, received $0.00.

In this example, the bot bought Up tokens (house=Up) but BTC settled Down. Every Up fill loses its full purchase price. Every Down fill (if any, from lp_extreme) would win.

### Per-Strategy Breakdown

| Field | Meaning |
|-------|---------|
| `sig=441` | Signals generated by this strategy |
| `ord=2` | Orders dispatched (passed risk) |
| `fill=2` | Orders confirmed filled |
| `pnl=$-8.80` | Realized PnL for this strategy's fills |
| `avg_edge=0.130` | Average edge at time of signal (what the model predicted). High avg_edge with negative PnL means the model was confident but wrong |

---

## Common Issues

### All strategies blocked by regime=Trend

BTC is genuinely trending (75%+ of direction-changing ticks going one way in the 30s window). The convexity_fade and lp_extreme strategies will not fire during Trend regime because fading a trend is adverse selection. Wait for the regime to return to Range or Ambiguous.

### Stale PM quotes (0.990/0.990)

Both up_ask and down_ask at 0.990 means Polymarket's WebSocket is not delivering real quotes. This can happen when:
- The Polymarket CLOB WS connection dropped silently
- The market has no liquidity yet (just opened)
- The 5s stale feed gate in risk.rs will block all new orders

Check with: `grep 'WARN.*Stale' /root/nitro-fig/logs/latest.log`

### No orders after first burst

The cooldown timer has not expired yet. Each strategy has a per-strategy cooldown:
- latency_arb: 60s
- certainty_capture: 120s
- convexity_fade: 60s
- strike_misalign: 15s
- lp_extreme: 120s

After an order, the strategy is locked out until the cooldown expires. This is intentional to limit to 4-6 orders per 5-minute market.

### EWMA always at floor

Two possible causes:
1. **Warmup not complete**: The EWMA needs 10 one-second samples before it reports valid sigma. Check with `grep 'Warmup complete' /root/nitro-fig/logs/latest.log`. First market after restart takes ~10s.
2. **Vol genuinely low**: BTC is trading flat. The sigma floor (30% annualized = ~0.0000534/s) prevents overconfidence. If raw sigma is below the floor, the floor binds. This is working as intended.

### Wrong-side PnL

Expected behavior. `house_side` is a market prediction based on the first active order. Sometimes the house is wrong and the bot loses. Check `avg_edge` in the settlement log: if avg_edge was reasonable (3-15 cents), the model had a valid edge but BTC moved against it. This is normal variance for a binary bet.

### Telegram alerts not showing

Check for `[TG]` errors in the log:
```bash
grep TG /root/nitro-fig/logs/latest.log
```

Common causes:
- **HTTP errors**: `[TG] Send failed: 400` usually means the message body contains characters that break Telegram's HTML parse mode. Strategy names with underscores (like `certainty_capture`) can break `<code>` tags if not escaped.
- **Network errors**: `[TG] Request error:` means the VPS cannot reach `api.telegram.org`. Check DNS and outbound HTTPS.
- **Invalid token/chat_id**: Verify `TELEGRAM_BOT_TOKEN` and `TELEGRAM_CHAT_ID` in `start.sh`.

---

## Risk Limits Quick Reference

Current per-strategy limits from `risk.rs` (based on $1000 bankroll):

| Strategy | Per-trade | Total cap | Cooldown | Max orders |
|----------|-----------|-----------|----------|------------|
| latency_arb | $20 (2%) | $40 (4%) | 60s | 2 |
| certainty_capture | $30 (3%) | $30 (3%) | 120s | 1 |
| convexity_fade | $10 (1%) | $20 (2%) | 60s | 2 |
| strike_misalign | $20 (2%) | $20 (2%) | 15s | 1 |
| lp_extreme | $20 (2%) | $20 (2%) | 120s | 1 |

**Portfolio-level caps**:
- Max total exposure: 15% of bankroll = $150
- Daily loss halt: -3% of bankroll = -$30
- Weekly loss halt: -8% of bankroll = -$80
- Stale feed rejection: 5s threshold (either Binance or Polymarket)

**Sizing flow**: `signal.size_frac * bankroll` -> capped by per-trade limit -> capped by strategy room (total cap - current exposure) -> capped by portfolio room ($150 - total exposure) -> minimum $1.

---

## Useful One-Liners

```bash
# Count fills per market
grep -c 'FILL.*Filled' /root/nitro-fig/logs/latest.log

# See per-strategy order breakdown at settlement
grep 'ENGINE.*:' /root/nitro-fig/logs/latest.log

# Check EWMA warmup status
grep 'Warmup complete' /root/nitro-fig/logs/latest.log

# Watch regime shifts in real time
tail -f /root/nitro-fig/logs/latest.log | grep DIAG | awk -F'regime=' '{print $2}' | cut -d' ' -f1

# See Telegram delivery errors
grep TG /root/nitro-fig/logs/latest.log

# Signal-to-order conversion rate
echo "Signals: $(grep -c SIG /root/nitro-fig/logs/latest.log) Orders: $(grep -c 'FILL.*Filled' /root/nitro-fig/logs/latest.log)"

# Count regime types in current session
grep -c 'regime=Range' /root/nitro-fig/logs/latest.log
grep -c 'regime=Ambiguous' /root/nitro-fig/logs/latest.log
grep -c 'regime=Trend' /root/nitro-fig/logs/latest.log

# See all market settlement results
grep 'ENGINE.*ended' /root/nitro-fig/logs/latest.log

# Watch for risk halts
grep RISK /root/nitro-fig/logs/latest.log

# Check if bot is running
ps aux | grep bot

# Stop the bot
pkill -f "target/release/bot"
```
